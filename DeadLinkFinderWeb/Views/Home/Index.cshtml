@model DeadLinkFinderWeb.Models.RepoCheckerModel

@{
    ViewData["Title"] = "GitHub README Link Checker";
}

<div class="main-container">
    <!-- Search Section -->
    <div class="search-section" id="searchSection">
        <div class="search-container">
            <h1 class="main-title">GitHub README Link Checker</h1>
            <p class="subtitle">Check for broken links in your GitHub repository README files</p>
            
            <form id="searchForm" class="search-form">
                <div class="input-group">
                    <input type="text" 
                           id="userOrOrgInput" 
                           class="form-control modern-input" 
                           placeholder="GitHub username or org" 
                           required />
                    <button type="submit" class="btn btn-primary modern-btn" id="searchBtn">
                        <span class="btn-text">Check Repos</span>
                        <span class="btn-spinner" style="display: none;">
                            <i class="fa fa-spinner fa-spin"></i>
                        </span>
                    </button>
                </div>
                <div class="error-message" id="errorMessage" style="display: none;"></div>
            </form>
        </div>
    </div>

    <!-- Loading State -->
    <div class="loading-section" id="loadingSection" style="display: none;">
        <div class="loading-content">
            <i class="fa fa-spinner fa-spin fa-3x"></i>
            <p>Fetching repositories...</p>
        </div>
    </div>

    <!-- Results Section -->
    <div class="results-section" id="resultsSection" style="display: none;">
        <div class="results-header">
            <div class="results-header-text">
                <p class="results-description">Checking README links for your repositories. Use the panel to select which repos to check.</p>
            </div>
            <div class="results-header-actions">
                <button class="btn btn-primary btn-sm sticky-select-btn" id="togglePanelBtn" onclick="toggleSidePanel()">
                    <i class="fa fa-list"></i> Select Repos
                </button>
                <button class="btn btn-secondary btn-sm" onclick="resetSearch()">New Search</button>
            </div>
        </div>
        
        <div class="repos-container" id="reposContainer">
            <!-- Repos will be dynamically added here -->
        </div>
    </div>

    <!-- Side Panel Overlay -->
    <div class="side-panel-overlay" id="sidePanelOverlay" onclick="toggleSidePanel()"></div>

    <!-- Side Panel -->
    <div class="side-panel" id="sidePanel">
        <div class="side-panel-header">
            <h3>Select Repositories</h3>
            <button class="side-panel-close" onclick="toggleSidePanel()">
                <i class="fa fa-times"></i>
            </button>
        </div>
        <div class="side-panel-controls">
            <div class="sort-control">
                <label for="sortSelect">Sort by:</label>
                <select id="sortSelect" class="form-control" onchange="sortRepos()">
                    <option value="updated">Last Updated</option>
                    <option value="name">Name A-Z</option>
                </select>
            </div>
            <div class="search-control">
                <input type="text" 
                       id="repoSearchInput" 
                       class="form-control" 
                       placeholder="Search repositories..." 
                       onkeyup="filterRepos()" />
            </div>
        </div>
        <div class="side-panel-content">
            <div class="repos-list-container" id="reposListContainer">
                <!-- Available repos will be listed here -->
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}

    <script>
        let allRepos = [];
        let checkedRepos = new Set();
        let currentUserOrOrg = '';
        const LAST_SEARCH_KEY = 'dlf:lastSearch';

        function saveLastSearch(value) {
            try {
                if (value) {
                    localStorage.setItem(LAST_SEARCH_KEY, value);
                }
            } catch (e) {
                console.warn('Unable to save last search', e);
            }
        }

        function getLastSearch() {
            try {
                return localStorage.getItem(LAST_SEARCH_KEY);
            } catch (e) {
                console.warn('Unable to read last search', e);
                return null;
            }
        }

        function clearLastSearch() {
            try {
                localStorage.removeItem(LAST_SEARCH_KEY);
            } catch (e) {
                console.warn('Unable to clear last search', e);
            }
        }

        // Handle form submission
        $('#searchForm').on('submit', function(e) {
            e.preventDefault();
            const userOrOrg = $('#userOrOrgInput').val().trim();
            
            if (!userOrOrg) {
                showError('Please enter a GitHub username or organization');
                return;
            }

            currentUserOrOrg = userOrOrg;
            clearLastSearch();
            $('#searchSection').hide();
            $('#loadingSection').show();
            $('#errorMessage').hide();
            $('#searchBtn .btn-text').hide();
            $('#searchBtn .btn-spinner').show();
            $('#searchBtn').prop('disabled', true);

            // Fetch repos and start checking
            fetchAndCheckRepos(userOrOrg);
        });

        function fetchAndCheckRepos(userOrOrg) {
            // First, get all available repos
            $.ajax({
                type: 'GET',
                url: '@Url.Action("GetUserRepos", "Home")',
                data: { userOrOrg: userOrOrg, maxRepos: 100 },
                dataType: 'json',
                success: function(repos) {
                    if (repos.error) {
                        showError(repos.error);
                        resetToSearch();
                        return;
                    }

                    allRepos = repos;
                    checkedRepos.clear();
                    saveLastSearch(userOrOrg);

                    // Get the 5 most recent repos
                    const reposToCheck = repos.slice(0, 5);
                    
                    $('#loadingSection').hide();
                    $('#resultsSection').show();
                    $('#reposContainer').empty();

                    // Display all repos in side panel
                    displayAvailableRepos(repos);

                    // Auto-check and start checking first 5 repos
                    reposToCheck.forEach(function(repo) {
                        addRepoCard(repo);
                        checkRepo(repo.url, repo.branch, repo.name);
                        checkedRepos.add(repo.url);
                        // Update checkbox in side panel
                        $(`.repo-checkbox[value="${repo.url}"]`).prop('checked', true);
                    });

                    resetToSearch();
                },
                error: function(xhr) {
                    showError('Failed to fetch repositories. Please check the username/organization name.');
                    resetToSearch();
                }
            });
        }

        function addRepoCard(repo) {
            const repoId = convertUriToValidId(repo.url);
            const cardHtml = `
                <div class="repo-card" id="repo-card-${repoId}" data-repo-url="${repo.url}">
                    <button class="repo-card-close" onclick="removeRepoCard('${repo.url}')" title="Remove">
                        <i class="fa fa-times"></i>
                    </button>
                    <div class="repo-card-header">
                        <div class="repo-status" id="repo-status-${repoId}">
                            <div class="status-checking" title="Checking" aria-label="Checking" role="status">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                        <div class="repo-info">
                            <h3 class="repo-name">
                                <a href="${repo.url}" target="_blank">${repo.name}</a>
                            </h3>
                            <div class="repo-meta">
                                <span class="repo-meta-item"><i class="fa fa-star"></i> ${repo.stars} stars</span>
                                <span class="repo-meta-item"><i class="fa fa-eye"></i> ${repo.watchers || 0} watching</span>
                                <span class="repo-meta-item"><i class="fa fa-code-fork"></i> ${repo.forks || 0} forks</span>
                                ${repo.updatedAt ? `<span class="repo-meta-item"><i class="fa fa-clock-o"></i> ${formatRelativeTime(new Date(repo.updatedAt))}</span>` : ''}
                            </div>
                        </div>
                    </div>
                    <div class="repo-card-body" id="repo-body-${repoId}">
                        <div class="link-counts" id="link-counts-${repoId}" style="display: none;">
                            <span class="badge badge-ok filter-badge" data-filter="ok" onclick="toggleBadgeFilter('${repoId}', 'ok')" id="badge-ok-${repoId}">0 OK</span>
                            <span class="badge badge-warning filter-badge active" data-filter="warning" onclick="toggleBadgeFilter('${repoId}', 'warning')" id="badge-warning-${repoId}">0 Warning</span>
                            <span class="badge badge-error filter-badge active" data-filter="bad" onclick="toggleBadgeFilter('${repoId}', 'bad')" id="badge-error-${repoId}">0 Bad</span>
                        </div>
                        <div class="link-details" id="link-details-${repoId}" style="display: none;">
                            <!-- Link details will be added here -->
                        </div>
                    </div>
                </div>
            `;
            $('#reposContainer').append(cardHtml);
        }

        function checkRepo(uri, branch, repoName) {
            const repoId = convertUriToValidId(uri);
            
            $.ajax({
                type: 'GET',
                url: '@Url.Action("CheckRepo", "Home")',
                data: { projectBaseUrl: uri, branch: branch },
                dataType: 'json',
                cache: false,
                success: function(data) {
                    updateRepoStatus(repoId, data, uri, repoName);
                },
                error: function() {
                    $('#repo-status-' + repoId).html('<div class="status-error" title="Error checking repo" aria-label="Error checking repo" role="status"><i class="fa fa-exclamation-triangle"></i></div>');
                }
            });
        }

        function updateRepoStatus(repoId, data, uri, repoName) {
            let ok = 0, bad = 0, warning = 0;
            const badLinks = [];
            const warningLinks = [];
            const okLinks = [];

            $.each(data, function(key) {
                const statusCode = data[key].httpStatusCode;
                const link = {
                    uri: data[key].uriText,
                    statusCode: statusCode,
                    statusText: data[key].httpStatusCodeText
                };

                if (statusCode == 200) {
                    ok++;
                    okLinks.push(link);
                } else if (statusCode == 404) {
                    bad++;
                    badLinks.push(link);
                } else {
                    warning++;
                    warningLinks.push(link);
                }
            });

            // Update status indicator
            let statusHtml = '<div class="status-success" title="All links OK" aria-label="All links OK" role="status"><i class="fa fa-check-circle"></i></div>';
            let statusClass = 'status-success';
            if (bad > 0) {
                statusHtml = '<div class="status-error" title="Issues found" aria-label="Issues found" role="status"><i class="fa fa-times-circle"></i></div>';
                statusClass = 'status-error';
            } else if (warning > 0) {
                statusHtml = '<div class="status-warning" title="Warnings found" aria-label="Warnings found" role="status"><i class="fa fa-exclamation-triangle"></i></div>';
                statusClass = 'status-warning';
            }
            $('#repo-status-' + repoId).html(statusHtml);
            $('#repo-card-' + repoId).addClass(statusClass);

            // Update counts
            $('#badge-ok-' + repoId).text(ok + ' OK');
            $('#badge-warning-' + repoId).text(warning + ' Warning');
            $('#badge-error-' + repoId).text(bad + ' Bad');
            $('#link-counts-' + repoId).show();

            // Add link details
            let detailsHtml = '';
            
            if (badLinks.length > 0) {
                detailsHtml += '<div class="link-group"><h4 class="link-group-title error-title"><i class="fa fa-times-circle"></i> Bad Links (' + bad + ')</h4><div class="link-list" data-link-type="bad">';
                badLinks.forEach(function(link) {
                    detailsHtml += `<div class="link-item error-link" data-link-type="bad">
                        <span class="link-status">${link.statusText} (${link.statusCode})</span>
                        <a href="${link.uri}" target="_blank" class="link-url">${link.uri}</a>
                    </div>`;
                });
                detailsHtml += '</div></div>';
            }

            if (warningLinks.length > 0) {
                detailsHtml += '<div class="link-group"><h4 class="link-group-title warning-title"><i class="fa fa-exclamation-triangle"></i> Warning Links (' + warning + ')</h4><div class="link-list" data-link-type="warning">';
                warningLinks.forEach(function(link) {
                    detailsHtml += `<div class="link-item warning-link" data-link-type="warning">
                        <span class="link-status">${link.statusText} (${link.statusCode})</span>
                        <a href="${link.uri}" target="_blank" class="link-url">${link.uri}</a>
                    </div>`;
                });
                detailsHtml += '</div></div>';
            }

            if (okLinks.length > 0) {
                detailsHtml += '<div class="link-group collapsible"><h4 class="link-group-title ok-title" onclick="toggleLinkGroup(this)"><i class="fa fa-check-circle"></i> OK Links (' + ok + ') <i class="fa fa-chevron-down"></i></h4><div class="link-list" data-link-type="ok">';
                okLinks.forEach(function(link) {
                    detailsHtml += `<div class="link-item ok-link" data-link-type="ok">
                        <span class="link-status">${link.statusText} (${link.statusCode})</span>
                        <a href="${link.uri}" target="_blank" class="link-url">${link.uri}</a>
                    </div>`;
                });
                detailsHtml += '</div></div>';
            }

            if (detailsHtml) {
                $('#link-details-' + repoId).html(detailsHtml).show();
                setBadgeDefaults(repoId);
            }
        }

        function displayAvailableRepos(repos) {
            const container = $('#reposListContainer');
            container.empty();
            
            repos.forEach(function(repo) {
                const repoId = convertUriToValidId(repo.url);
                const isChecked = checkedRepos.has(repo.url);
                const updatedDate = repo.updatedAt ? new Date(repo.updatedAt) : null;
                const updatedText = updatedDate ? formatRelativeTime(updatedDate) : '';
                const checkboxHtml = `
                    <div class="repo-list-item ${isChecked ? 'checked' : ''}" data-repo-url="${repo.url}" data-repo-name="${repo.name.toLowerCase()}" data-updated="${repo.updatedAt || ''}">
                        <label class="repo-checkbox-label">
                            <input type="checkbox" 
                                   class="repo-checkbox" 
                                   value="${repo.url}" 
                                   data-branch="${repo.branch}"
                                   data-name="${repo.name}"
                                   data-fullname="${repo.fullName}"
                                   data-stars="${repo.stars}"
                                   data-watchers="${repo.watchers || 0}"
                                   data-forks="${repo.forks || 0}"
                                   data-updated="${repo.updatedAt || ''}"
                                   ${isChecked ? 'checked' : ''}
                                   onchange="handleRepoCheckboxChange(this)" />
                            <div class="repo-list-content">
                                <span class="repo-list-name">${repo.name}</span>
                                <div class="repo-list-meta">
                                    <span class="repo-list-stars"><i class="fa fa-star"></i> ${repo.stars}</span>
                                    ${updatedText ? `<span class="repo-list-updated">${updatedText}</span>` : ''}
                                </div>
                            </div>
                        </label>
                    </div>
                `;
                container.append(checkboxHtml);
            });
            
            // Apply current sort
            sortRepos();
        }

        function toggleSidePanel() {
            const panel = $('#sidePanel');
            const overlay = $('#sidePanelOverlay');
            if (panel.hasClass('open')) {
                panel.removeClass('open');
                overlay.removeClass('open');
            } else {
                panel.addClass('open');
                overlay.addClass('open');
            }
        }

        function handleRepoCheckboxChange(checkbox) {
            const $checkbox = $(checkbox);
            const repoUrl = $checkbox.val();
            const repo = {
                url: repoUrl,
                branch: $checkbox.data('branch'),
                name: $checkbox.data('name'),
                fullName: $checkbox.data('fullname'),
                stars: $checkbox.data('stars')
            };

            if ($checkbox.is(':checked')) {
                // Add repo card and start checking
                if (!checkedRepos.has(repoUrl)) {
                    addRepoCard(repo);
                    checkRepo(repo.url, repo.branch, repo.name);
                    checkedRepos.add(repoUrl);
                }
            } else {
                // Remove repo card
                removeRepoCard(repoUrl);
            }
        }

        function removeRepoCard(repoUrl) {
            const repoId = convertUriToValidId(repoUrl);
            const $card = $('#repo-card-' + repoId);
            
            if ($card.length) {
                $card.fadeOut(300, function() {
                    $(this).remove();
                });
            }
            
            // Uncheck in side panel
            $(`.repo-checkbox[value="${repoUrl}"]`).prop('checked', false);
            checkedRepos.delete(repoUrl);
        }

        function toggleBadgeFilter(repoId, filterType) {
            const $badge = $('#badge-' + filterType + '-' + repoId);
            $badge.toggleClass('active');
            applyBadgeFilters(repoId);
        }

        function setBadgeDefaults(repoId) {
            $('#badge-ok-' + repoId).removeClass('active');
            $('#badge-warning-' + repoId).addClass('active');
            $('#badge-bad-' + repoId).addClass('active');
            applyBadgeFilters(repoId);
        }

        function applyBadgeFilters(repoId) {
            const showOk = $('#badge-ok-' + repoId).hasClass('active');
            const showWarning = $('#badge-warning-' + repoId).hasClass('active');
            const showBad = $('#badge-bad-' + repoId).hasClass('active');

            // Show/hide entire link groups based on badge state
            // OK links
            const $okGroup = $('#link-details-' + repoId).find('.link-list[data-link-type="ok"]').closest('.link-group');
            if (showOk && $okGroup.length > 0) {
                $okGroup.show();
                $okGroup.find('.link-list[data-link-type="ok"]').show();
            } else if ($okGroup.length > 0) {
                $okGroup.hide();
            }

            // Warning links
            const $warningGroup = $('#link-details-' + repoId).find('.link-list[data-link-type="warning"]').closest('.link-group');
            if (showWarning && $warningGroup.length > 0) {
                $warningGroup.show();
                $warningGroup.find('.link-list[data-link-type="warning"]').show();
            } else if ($warningGroup.length > 0) {
                $warningGroup.hide();
            }

            // Bad links
            const $badGroup = $('#link-details-' + repoId).find('.link-list[data-link-type="bad"]').closest('.link-group');
            if (showBad && $badGroup.length > 0) {
                $badGroup.show();
                $badGroup.find('.link-list[data-link-type="bad"]').show();
            } else if ($badGroup.length > 0) {
                $badGroup.hide();
            }
        }

        function sortRepos() {
            const sortBy = $('#sortSelect').val();
            const container = $('#reposListContainer');
            const items = container.find('.repo-list-item').toArray();

            items.sort(function(a, b) {
                if (sortBy === 'name') {
                    const nameA = $(a).data('repo-name') || '';
                    const nameB = $(b).data('repo-name') || '';
                    return nameA.localeCompare(nameB);
                } else {
                    // Sort by updated date (most recent first)
                    const dateA = $(a).data('updated') || '';
                    const dateB = $(b).data('updated') || '';
                    if (!dateA && !dateB) return 0;
                    if (!dateA) return 1;
                    if (!dateB) return -1;
                    return new Date(dateB) - new Date(dateA);
                }
            });

            container.empty();
            items.forEach(function(item) {
                container.append(item);
            });
        }

        function formatRelativeTime(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            const diffMonths = Math.floor(diffDays / 30);
            const diffYears = Math.floor(diffDays / 365);

            if (diffMins < 1) return 'just now';
            if (diffMins < 60) return diffMins + ' min ago';
            if (diffHours < 24) return diffHours + ' hour' + (diffHours > 1 ? 's' : '') + ' ago';
            if (diffDays < 30) return diffDays + ' day' + (diffDays > 1 ? 's' : '') + ' ago';
            if (diffMonths < 12) return diffMonths + ' month' + (diffMonths > 1 ? 's' : '') + ' ago';
            return diffYears + ' year' + (diffYears > 1 ? 's' : '') + ' ago';
        }

        function filterRepos() {
            const searchTerm = $('#repoSearchInput').val().toLowerCase();
            $('.repo-list-item').each(function() {
                const repoName = $(this).find('.repo-list-name').text().toLowerCase();
                if (repoName.includes(searchTerm)) {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });
        }

        function toggleLinkGroup(element) {
            const linkList = $(element).next('.link-list');
            const chevron = $(element).find('.fa-chevron-down, .fa-chevron-up');
            linkList.slideToggle();
            chevron.toggleClass('fa-chevron-down fa-chevron-up');
        }

        function convertUriToValidId(uri) {
            return uri.replace(/[^A-Za-z0-9]/gi, '');
        }

        function showError(message) {
            $('#errorMessage').text(message).show();
        }

        function resetToSearch() {
            $('#searchBtn .btn-text').show();
            $('#searchBtn .btn-spinner').hide();
            $('#searchBtn').prop('disabled', false);
        }

        function resetSearch() {
            $('#searchSection').show();
            $('#resultsSection').hide();
            $('#loadingSection').hide();
            $('#sidePanel').removeClass('open');
            $('#sidePanelOverlay').removeClass('open');
            $('#userOrOrgInput').val('');
            $('#reposContainer').empty();
            $('#reposListContainer').empty();
            allRepos = [];
            checkedRepos.clear();
            clearLastSearch();
        }

        // Handle existing model data (backward compatibility)
        @if (Model != null && Model.RepoUrlsAndDefaultBranch != null && Model.RepoUrlsAndDefaultBranch.Count > 0)
        {
            <text>
            $(document).ready(function() {
                $('#searchSection').hide();
                $('#resultsSection').show();
                
                @foreach (var repoUrlAndDefaultBranch in Model.RepoUrlsAndDefaultBranch)
                {
                    var repoName = repoUrlAndDefaultBranch.RepoUri.Segments.Last().TrimEnd('/');
                    var fullName = repoUrlAndDefaultBranch.RepoUri.ToString().Replace("https://github.com/", "");
                    <text>
                    const repo = {
                        url: '@repoUrlAndDefaultBranch.RepoUri',
                        branch: '@repoUrlAndDefaultBranch.Branch',
                        name: '@repoName',
                        fullName: '@fullName',
                        stars: 0
                    };
                    addRepoCard(repo);
                    checkRepo(repo.url, repo.branch, repo.name);
                    checkedRepos.add(repo.url);
                    </text>
                }
            });
            </text>
        }

        $(document).ready(function() {
            const lastSearch = getLastSearch();
            if (lastSearch) {
                $('#userOrOrgInput').val(lastSearch);
                $('#searchForm').trigger('submit');
            }
        });
    </script>
}
